<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Basti Ki Pathshala Foundation</title>
    <link rel="stylesheet" href="/public/styles.css">
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <style>
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .admin-header {
            background: #1e3a8a;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .admin-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .admin-card h3 {
            margin-top: 0;
            color: #1e3a8a;
        }
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #ffcd05;
        }
        .btn {
            background: #ffcd05;
            color: #1e3a8a;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin: 5px;
        }
        .btn:hover {
            background: #f7b500;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .data-table th,
        .data-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        .data-table th {
            background: #f3f4f6;
            font-weight: bold;
        }
        #loading {
            text-align: center;
            padding: 40px;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1>üéì Admin Dashboard</h1>
            <p>Basti Ki Pathshala Foundation - Content Management</p>
            <div style="float: right;">
                <span id="user-info"></span>
                <button class="btn" onclick="logout()">Logout</button>
            </div>
            <div style="clear: both;"></div>
        </div>

        <div id="loading">
            <h2>Loading dashboard...</h2>
        </div>

        <div id="dashboard-content" class="hidden">
            <div class="admin-grid">
                <div class="admin-card">
                    <h3>üìö Programs</h3>
                    <div class="stat-number" id="programs-count">0</div>
                    <p>Educational programs</p>
                    <button class="btn" onclick="loadSection('programs')">Manage Programs</button>
                </div>

                <div class="admin-card">
                    <h3>üìù Success Stories</h3>
                    <div class="stat-number" id="posts-count">0</div>
                    <p>Published stories</p>
                    <button class="btn" onclick="loadSection('posts')">Manage Stories</button>
                </div>

                <div class="admin-card">
                    <h3>üìÖ Events</h3>
                    <div class="stat-number" id="events-count">0</div>
                    <p>Upcoming events</p>
                    <button class="btn" onclick="loadSection('events')">Manage Events</button>
                </div>

                <div class="admin-card">
                    <h3>ü§ù Partners</h3>
                    <div class="stat-number" id="partners-count">0</div>
                    <p>Partner organizations</p>
                    <button class="btn" onclick="loadSection('partners')">Manage Partners</button>
                </div>

                <div class="admin-card">
                    <h3>üìß Contact Messages</h3>
                    <div class="stat-number" id="messages-count">0</div>
                    <p>New messages</p>
                    <button class="btn" onclick="loadSection('messages')">View Messages</button>
                </div>

                <div class="admin-card">
                    <h3>üë• Volunteers</h3>
                    <div class="stat-number" id="volunteers-count">0</div>
                    <p>Volunteer applications</p>
                    <button class="btn" onclick="loadSection('volunteers')">Manage Volunteers</button>
                </div>
            </div>

            <div id="section-content">
                <div class="admin-card">
                    <h3>Welcome to the Admin Dashboard</h3>
                    <p>Select a section above to manage your content. This dashboard allows you to:</p>
                    <ul>
                        <li>Manage educational programs and their descriptions</li>
                        <li>Publish and edit success stories</li>
                        <li>Create and manage community events</li>
                        <li>Maintain partner relationships</li>
                        <li>Respond to contact form submissions</li>
                        <li>Review volunteer applications</li>
                    </ul>
                    <p><strong>Note:</strong> This is a simplified admin interface for Netlify deployment. For full functionality, consider using a headless CMS like Netlify CMS or Forestry.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        const apiBase = '/.netlify/functions/api';

        // Initialize Netlify Identity
        if (window.netlifyIdentity) {
            window.netlifyIdentity.on("init", user => {
                if (!user) {
                    window.netlifyIdentity.open();
                } else {
                    currentUser = user;
                    document.getElementById('user-info').textContent = `Welcome, ${user.user_metadata?.full_name || user.email}`;
                    loadDashboard();
                }
            });

            window.netlifyIdentity.on("login", user => {
                currentUser = user;
                document.getElementById('user-info').textContent = `Welcome, ${user.user_metadata?.full_name || user.email}`;
                loadDashboard();
            });

            window.netlifyIdentity.on("logout", () => {
                currentUser = null;
                window.location.href = '/admin/';
            });
        }

        function logout() {
            if (window.netlifyIdentity) {
                window.netlifyIdentity.logout();
            }
        }

        async function apiCall(endpoint) {
            try {
                const response = await fetch(`${apiBase}/${endpoint}`);
                if (response.ok) {
                    return await response.json();
                }
            } catch (error) {
                console.error('API call failed:', error);
            }
            return [];
        }

        async function loadDashboard() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('dashboard-content').classList.remove('hidden');

            // Load counts for each section
            const programs = await apiCall('programs');
            const posts = await apiCall('posts');
            const events = await apiCall('events');
            const partners = await apiCall('partners');

            document.getElementById('programs-count').textContent = programs.length;
            document.getElementById('posts-count').textContent = posts.length;
            document.getElementById('events-count').textContent = events.length;
            document.getElementById('partners-count').textContent = partners.length;
            document.getElementById('messages-count').textContent = '0'; // Netlify Forms handles this
            document.getElementById('volunteers-count').textContent = '0'; // Netlify Forms handles this
        }

        async function loadSection(section) {
            const content = document.getElementById('section-content');
            
            switch (section) {
                case 'programs':
                    const programs = await apiCall('programs');
                    content.innerHTML = `
                        <div class="admin-card">
                            <h3>üìö Educational Programs</h3>
                            <button class="btn" onclick="addProgram()">Add New Program</button>
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Description</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${programs.map(program => `
                                        <tr>
                                            <td>${program.title}</td>
                                            <td>${program.description.substring(0, 100)}...</td>
                                            <td>${new Date(program.created_at).toLocaleDateString()}</td>
                                            <td>
                                                <button class="btn" onclick="editProgram(${program.id})">Edit</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                    break;

                case 'messages':
                    content.innerHTML = `
                        <div class="admin-card">
                            <h3>üìß Contact Messages</h3>
                            <p>Contact form submissions are handled by Netlify Forms. To view messages:</p>
                            <ol>
                                <li>Go to your <a href="https://app.netlify.com" target="_blank">Netlify Dashboard</a></li>
                                <li>Select your site</li>
                                <li>Navigate to "Forms" in the sidebar</li>
                                <li>View all form submissions and set up email notifications</li>
                            </ol>
                            <a href="https://app.netlify.com" target="_blank" class="btn">Open Netlify Dashboard</a>
                        </div>
                    `;
                    break;

                default:
                    content.innerHTML = `
                        <div class="admin-card">
                            <h3>${section.charAt(0).toUpperCase() + section.slice(1)} Management</h3>
                            <p>This section is under development. For now, you can:</p>
                            <ul>
                                <li>Use the Netlify Dashboard to manage form submissions</li>
                                <li>Edit content files directly in your repository</li>
                                <li>Use a headless CMS like Netlify CMS for full content management</li>
                            </ul>
                            <p><strong>Recommendation:</strong> Set up Netlify CMS for a complete admin experience.</p>
                        </div>
                    `;
            }
        }

        function addProgram() {
            alert('Add Program functionality would be implemented here. For now, please add programs by editing the data files or using a headless CMS.');
        }

        function editProgram(id) {
            alert(`Edit Program ${id} functionality would be implemented here. For now, please edit programs by updating the data files or using a headless CMS.`);
        }
    </script>
</body>
</html>